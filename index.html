<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escolha Certa</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f5c518" />
  <meta name="mobile-web-app-capable" content="yes" />

  <!-- iOS (Safari) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Escolha Certa" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- Fallback favicon -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#080808;
      --surface:#111111;
      --surface2:#181818;
      --border:#222222;
      --border2:#2a2a2a;
      --text:#f0f0f0;
      --text2:#888888;
      --text3:#555555;
      --acc:#f5c518;
      --acc-dim:#f5c51822;
      --ok:#22c55e;
      --ok-dim:#22c55e18;
      --warn:#f5c518;
      --danger:#ef4444;
      --input:#0d0d0d;
      --radius:10px;
      --radius-lg:14px;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:'DM Sans', sans-serif;
      font-size:15px;
      font-weight:400;
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header{
      padding:20px 20px 16px;
      border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:100;
      background:rgba(8,8,8,.92);
      backdrop-filter:blur(12px);
      text-align:center;
    }
    h1{
      margin:0;
      font-size:20px;
      font-weight:700;
      letter-spacing:-.01em;
      color:var(--text);
    }
    h1 span{color:var(--acc)}
    .sub{
      color:var(--text3);
      font-size:12px;
      margin-top:3px;
      letter-spacing:.02em;
      text-transform:uppercase;
    }

    /* â”€â”€ LAYOUT â”€â”€ */
    main{padding:0;max-width:960px;margin:0 auto;text-align:center}
    .stack-blocks{
      display:flex;flex-direction:column;
      align-items:center;gap:1px;
      padding:0 0 32px;
    }

    /* â”€â”€ CARD â”€â”€ */
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:18px 16px;
      text-align:left;
      width:100%;max-width:560px;
    }
    .card .card{
      background:var(--surface2);
      border-color:var(--border2);
      border-radius:var(--radius);
      padding:14px;
      width:100%;max-width:100%;
    }

    /* â”€â”€ BLOCK HEADER â”€â”€ */
    .block-title{
      text-align:center;
      font-size:15px;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--text2);
      padding:18px 0 14px;
      width:100%;max-width:560px;
    }

    /* â”€â”€ SECTION HEADING (colapsÃ¡vel) â”€â”€ */
    .section-head{
      display:flex;align-items:center;justify-content:center;gap:10px;
      cursor:pointer;user-select:none;
      font-size:11px;font-weight:600;
      letter-spacing:.12em;text-transform:uppercase;
      color:var(--text3);
      margin-bottom:14px;
    }
    .section-head:hover{color:var(--text2)}
    .section-icon{
      width:20px;height:20px;border-radius:50%;
      background:var(--surface2);border:1px solid var(--border2);
      display:inline-flex;align-items:center;justify-content:center;
      font-size:13px;font-weight:700;color:var(--text3);
      flex-shrink:0;transition:all .2s;
    }
    .section-head:hover .section-icon{border-color:var(--acc);color:var(--acc)}

    /* â”€â”€ GRID DE RESULTADOS â”€â”€ */
    .grid{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:560px){.grid{grid-template-columns:1fr 1fr}}

    /* â”€â”€ RESULTADO PRINCIPAL â”€â”€ */
    .decisor-answer{
      text-align:center;
      font-size:32px;
      font-weight:700;
      color:var(--ok);
      letter-spacing:-.02em;
      padding:8px 0 16px;
    }
    .decisor-label{
      text-align:center;
      font-size:10px;
      font-weight:600;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--text3);
      margin-bottom:2px;
    }

    /* â”€â”€ RESULTADO CARD â”€â”€ */
    .result{
      font-size:22px;font-weight:700;
      text-align:center;
      font-family:'DM Mono', monospace;
      color:var(--text);
      margin-top:4px;
    }
    .result.ok{color:var(--ok)}
    .result.warn{color:var(--acc)}

    .tag{
      font-size:10px;font-weight:600;
      text-transform:uppercase;letter-spacing:.1em;
      color:var(--text3);text-align:center;
    }

    /* â”€â”€ INPUTS â”€â”€ */
    .row{
      display:grid;grid-template-columns:1fr 148px;
      gap:10px;align-items:center;margin:10px 0;
    }
    label{
      font-size:14px;font-weight:500;
      color:var(--text2);
    }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:var(--radius);
      border:1px solid var(--border2);
      background:var(--input);
      color:var(--text);
      font-family:'DM Sans',sans-serif;
      font-size:15px;
      font-weight:600;
      transition:border-color .15s;
      -webkit-appearance:none;
    }
    input:focus{outline:none;border-color:var(--acc)}
    input::placeholder{color:var(--text3);font-weight:400}
    input:disabled{opacity:.4;cursor:not-allowed}

    .input-wrap{position:relative;display:flex;align-items:center;width:148px}
    .input-wrap .prefix,.input-wrap .suffix{
      position:absolute;
      color:var(--text3);font-size:13px;font-weight:600;
      pointer-events:none;z-index:1;
    }
    .input-wrap .prefix{left:10px}
    .input-wrap .suffix{right:10px}
    .input-wrap input{width:100%}
    .input-wrap.has-prefix input{padding-left:26px}
    .input-wrap.has-suffix input{padding-right:24px}

    /* â”€â”€ TOGGLE SWITCH â”€â”€ */
    .toggle-row{
      display:grid;grid-template-columns:1fr auto 148px;
      gap:10px;align-items:center;margin:10px 0;
    }
    .toggle-switch{
      display:flex;align-items:center;gap:6px;
      font-size:11px;font-weight:700;
      white-space:nowrap;
    }
    .toggle-switch .lbl-pct{color:var(--acc)}
    .toggle-switch .lbl-brl{color:var(--text3)}
    .toggle-switch.is-brl .lbl-pct{color:var(--text3)}
    .toggle-switch.is-brl .lbl-brl{color:var(--acc)}

    .sw-track{
      position:relative;width:38px;height:22px;
      border-radius:999px;
      background:var(--border2);
      cursor:pointer;
      transition:background .2s;
      flex-shrink:0;
    }
    .sw-track.on{background:var(--acc)}
    .sw-knob{
      position:absolute;top:3px;left:3px;
      width:16px;height:16px;border-radius:50%;
      background:#fff;
      transition:transform .2s;
      box-shadow:0 1px 4px rgba(0,0,0,.5);
    }
    .sw-track.on .sw-knob{transform:translateX(16px)}

    /* â”€â”€ TOGGLE MODO (auto-fin) â”€â”€ */
    .mode-toggle{
      display:flex;align-items:center;justify-content:center;
      gap:10px;margin-bottom:16px;
      font-size:12px;font-weight:600;
    }

    /* â”€â”€ DIVISOR â”€â”€ */
    hr{border:0;border-top:1px solid var(--border);margin:14px 0}

    /* â”€â”€ HINT â”€â”€ */
    .hint{
      font-size:11px;color:var(--text3);
      text-align:center;margin-top:10px;
      line-height:1.6;
    }

    /* â”€â”€ PILLS â”€â”€ */
    .stack{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
    .pill{
      display:inline-block;padding:4px 10px;
      border-radius:999px;
      background:var(--surface2);
      border:1px solid var(--border2);
      font-size:11px;color:var(--text3);
    }

    /* â”€â”€ FOOT â”€â”€ */
    .foot{
      margin-top:24px;padding-bottom:24px;
      color:var(--text3);font-size:11px;
      text-align:center;letter-spacing:.04em;
    }

    /* â”€â”€ MONO â”€â”€ */
    .mono{font-family:'DM Mono',monospace}

    /* â”€â”€ INSTALL BANNER â”€â”€ */
    .install-banner{
      display:none;position:fixed;bottom:16px;left:50%;
      transform:translateX(-50%);
      background:var(--surface);
      border:1px solid var(--acc);
      border-radius:var(--radius-lg);
      padding:12px 16px;gap:10px;align-items:center;z-index:999;
      box-shadow:0 8px 32px rgba(0,0,0,.8);
      max-width:360px;width:calc(100% - 32px);
      font-size:13px;
    }
    .install-banner .ico{font-size:22px}
    .install-banner .txt{flex:1;line-height:1.4}
    .install-banner .txt b{display:block;color:var(--text)}
    .install-banner .txt span{color:var(--text3);font-size:12px}
    .btn-acc{
      background:var(--acc);color:#000;border:none;
      padding:8px 14px;border-radius:8px;
      cursor:pointer;font-weight:700;font-size:12px;
      font-family:'DM Sans',sans-serif;
      white-space:nowrap;
    }
    .btn-acc:active{opacity:.85}
    .btn-x{
      background:transparent;border:none;
      color:var(--text3);cursor:pointer;
      font-size:18px;padding:0 4px;line-height:1;
    }

    /* â”€â”€ ANIMAÃ‡ÃƒO DE ENTRADA â”€â”€ */
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .card{animation:fadeUp .3s ease both}
  </style>
</head>
<body>
  <!-- Banner instalaÃ§Ã£o PWA (Android Chrome) -->
  <div id="install-banner" class="install-banner">
    <span class="ico">ðŸ“²</span>
    <div class="txt">
      <b>Adicionar Ã  tela inicial</b>
      <span>Use offline, sem abrir o navegador</span>
    </div>
    <button id="btn-install" class="btn-acc">Instalar</button>
    <button id="btn-dismiss" class="btn-x">âœ•</button>
  </div>

  <header>
    <div style="display:flex;align-items:center;justify-content:center;gap:12px">
      <img src="icon-192.png" alt="Escolha Certa" style="width:40px;height:40px;border-radius:10px;flex-shrink:0" onerror="this.style.display='none'"/>
      <div>
        <h1><span>Escolha</span> Certa</h1>
        <div class="sub">PIX Â· CartÃ£o Â· Autoâ€‘financiamento</div>
      </div>
    </div>
  </header>

  <main>
    <div class="stack-blocks">

      <!-- Compra -->
      <div class="block-title">Compra</div>
      <div class="card" style="width:100%;max-width:560px">
        <div class="row"><label>Valor da compra</label><div class="input-wrap has-prefix"><span class="prefix">R$</span><input id="valor" type="text" inputmode="decimal" placeholder="0,00" /></div></div>
        <div class="toggle-row">
          <label id="lblDescPix">Desconto PIX</label>
          <div class="toggle-switch" id="toggleDescPix">
            <span class="lbl-pct">%</span>
            <div class="sw-track" id="swTrackDescPix"><div class="sw-knob"></div></div>
            <span class="lbl-brl">R$</span>
          </div>
          <div class="input-wrap has-suffix" id="wrapDescPixPct"><input id="descPix" type="text" inputmode="decimal" placeholder="ex.: 5"/><span class="suffix">%</span></div>
          <div class="input-wrap has-prefix" id="wrapDescPixBrl" style="display:none"><span class="prefix">R$</span><input id="descPixBrl" type="text" inputmode="decimal" placeholder="0,00"/></div>
        </div>
        <div id="pctDescPix" style="display:none;text-align:right;font-size:12px;color:var(--acc);margin:-6px 0 8px;font-weight:700"></div>

        <div class="toggle-row">
          <label id="lblDescAvista">Desconto Ã  vista no cartÃ£o</label>
          <div class="toggle-switch" id="toggleDescAvista">
            <span class="lbl-pct">%</span>
            <div class="sw-track" id="swTrackDescAvista"><div class="sw-knob"></div></div>
            <span class="lbl-brl">R$</span>
          </div>
          <div class="input-wrap has-suffix" id="wrapDescAvistaPct"><input id="descAvista" type="text" inputmode="decimal" placeholder="ex.: 0"/><span class="suffix">%</span></div>
          <div class="input-wrap has-prefix" id="wrapDescAvistaBrl" style="display:none"><span class="prefix">R$</span><input id="descAvistaBrl" type="text" inputmode="decimal" placeholder="0,00"/></div>
        </div>
        <div id="pctDescAvista" style="display:none;text-align:right;font-size:12px;color:var(--acc);margin:-6px 0 8px;font-weight:700"></div>

        <div class="row"><label>Parcelas sem juros (nÂº)</label><div class="input-wrap"><input id="parcelas" type="number" min="1" step="1" placeholder="ex.: 6"/></div></div>
        <div class="toggle-row">
          <label>Cashback do cartÃ£o</label>
          <div class="toggle-switch" id="toggleCashback">
            <span class="lbl-pct">%</span>
            <div class="sw-track" id="swTrackCashback"><div class="sw-knob"></div></div>
            <span class="lbl-brl">R$</span>
          </div>
          <div class="input-wrap has-suffix" id="wrapCashbackPct"><input id="cashback" type="text" inputmode="decimal" value="1,65"/><span class="suffix">%</span></div>
          <div class="input-wrap has-prefix" id="wrapCashbackBrl" style="display:none"><span class="prefix">R$</span><input id="cashbackBrl" type="text" inputmode="decimal" placeholder="0,00"/></div>
        </div>
        <div id="pctCashback" style="display:none;text-align:right;font-size:12px;color:var(--acc);margin:-6px 0 8px;font-weight:700"></div>
        <div class="row"><label>Dia de fechamento (1â€“31)</label><div class="input-wrap"><input id="fechamento" type="number" min="1" max="31" step="1" value="06"/></div></div>
        <div class="row"><label>Dia de vencimento (1â€“31)</label><div class="input-wrap"><input id="vencimento" type="number" min="1" max="31" step="1" value="13"/></div></div>
      </div>

      <!-- Decisor -->
      <div class="block-title">Decisor</div>
      <div class="card" style="width:100%;max-width:560px">
        <div class="stack" style="display:none">
          <span class="pill"><span class="tag">Hoje</span> <span id="hoje" class="mono"></span></span>
          <span class="pill"><span class="tag">Fecha</span> <span id="fecha" class="mono"></span></span>
          <span class="pill"><span class="tag">Vence</span> <span id="vence" class="mono"></span></span>
          <span class="pill"><span class="tag">Dias atÃ© pagar</span> <span id="diasAte" class="mono"></span></span>
          <span class="pill"><span class="tag">Taxa mensal lÃ­quida</span> <span id="taxaMensal" class="mono"></span></span>
          <span class="pill"><span class="tag">Taxa diÃ¡ria</span> <span id="taxaDiaria" class="mono"></span></span>
        </div>
        <div class="decisor-label">Como devo pagar?</div>
        <div id="melhor" class="decisor-answer">â€”</div>
        <div class="grid" style="margin-top:8px">
          <div class="card"><div class="tag">PIX (valor real)</div><div id="pixReal" class="result">â€”</div></div>
          <div class="card"><div class="tag">CartÃ£o Ã  vista (valor real)</div><div id="avistaReal" class="result">â€”</div></div>
          <div class="card"><div class="tag">CartÃ£o parcelado (valor presente)</div><div id="parceladoReal" class="result">â€”</div></div>
        </div>
        <div class="grid" style="margin-top:8px">
          <div class="card"><div class="tag">Desconto mÃ­nimo para PIX valer</div><div id="descNecPix" class="result warn">â€”</div></div>
          <div class="card"><div class="tag">Desconto mÃ­nimo para Ã  vista valer</div><div id="descNecAvista" class="result warn">â€”</div></div>
        </div>
      </div>

      <!-- Auto-Financiamento -->
      <div class="block-title">Auto-Financiamento</div>
      <div class="card" style="width:100%;max-width:560px">
        <div class="section-head" id="toggleAutoFin">
          Auto-Financiamento
          <span class="section-icon" id="iconAutoFin">+</span>
        </div>
        <div id="bodyAutoFin" style="display:none">

          <!-- Toggle modo: nÂº parcelas / valor mÃ¡ximo -->
          <div class="mode-toggle">
            <span id="lblModoNper" style="color:var(--acc)">NÂº de parcelas</span>
            <div class="sw-track" id="swModoAuto"><div class="sw-knob"></div></div>
            <span id="lblModoValor" style="color:var(--text3)">Valor mÃ¡ximo/mÃªs</span>
          </div>

          <!-- Modo: nÂº de parcelas -->
          <div id="modoNper">
            <div class="row"><label>nÂº de parcelas</label><div class="input-wrap"><input id="nAuto" type="number" min="0" step="1" value="0"/></div></div>
            <div class="card" style="margin-top:8px"><div class="tag">Valor para me pagar por mÃªs</div><div id="pmtAuto" class="result">â€”</div></div>
            <div class="card" style="margin-top:8px"><div class="tag">Total</div><div id="pmtTotal" class="result">â€”</div></div>
            <div class="card" style="margin-top:8px"><div class="tag">Taxa</div><div id="pmtTaxa" class="result warn">â€”</div></div>
          </div>

          <!-- Modo: valor mÃ¡ximo por mÃªs -->
          <div id="modoValor" style="display:none">
            <div class="row"><label>Valor mÃ¡ximo que desejo pagar por mÃªs</label><div class="input-wrap has-prefix"><span class="prefix">R$</span><input id="pmtDesejado" type="text" inputmode="decimal" value="0"/></div></div>
            <div class="card" style="margin-top:8px"><div class="tag">Qtd de parcelas sugerida</div><div id="nperAuto" class="result">â€”</div></div>
            <div class="card" style="margin-top:8px"><div class="tag">Parcela sugerida</div><div id="nperParcela" class="result">â€”</div></div>
            <div class="card" style="margin-top:8px"><div class="tag">Total</div><div id="nperTotal" class="result">â€”</div></div>
            <div class="card" style="margin-top:8px"><div class="tag">Taxa</div><div id="nperTaxa" class="result warn">â€”</div></div>
          </div>

        </div>
      </div>

      <!-- ParÃ¢metros financeiros -->
      <div class="block-title">ConfiguraÃ§Ãµes</div>
      <div class="card" style="width:100%;max-width:560px">
        <div class="section-head" id="toggleParams">
          ParÃ¢metros financeiros
          <span class="section-icon" id="iconParams">+</span>
        </div>
        <div id="bodyParams" style="display:none">
          <div class="row"><label>CDI (ao ano)</label><div class="input-wrap has-suffix"><input id="cdi" type="text" inputmode="decimal" value="15,00"/><span class="suffix">%</span></div></div>
          <div class="row"><label>% do CDI do banco</label><div class="input-wrap has-suffix"><input id="pctCdiBanco" type="text" inputmode="decimal" value="100"/><span class="suffix">%</span></div></div>
          <div class="row"><label>IR (alÃ­quota)</label><div class="input-wrap has-suffix"><input id="ir" type="text" inputmode="decimal" value="22,5"/><span class="suffix">%</span></div></div>
          <div class="hint">CDI conservador fixo de 0,10% a.a. incluso no cÃ¡lculo.</div>
        </div>
      </div>

      <div class="foot">Criado e compartilhado por Rafael</div>
    </div>
  </main>

  <script>
    const fmtBRL = v => (isFinite(v)? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : 'â€”');
    const fmtPct = v => (isFinite(v)? (100*v).toFixed(2).replace('.',',')+'%' : 'â€”');

    const el = id => document.getElementById(id);

    // Converte string com vÃ­rgula para nÃºmero
    function safeNum(n){
      if(typeof n === 'string') n = n.replace(/\./g,'').replace(',','.');
      const x = parseFloat(n);
      return isFinite(x)? x : 0;
    }

    // MÃ¡scara monetÃ¡ria: formata como "1.234,56"
    function maskMoney(input){
      let v = input.value.replace(/\D/g,'');
      if(!v){ input.value=''; return; }
      let num = parseInt(v, 10) / 100;
      input.value = num.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
    }

    // MÃ¡scara percentual: permite atÃ© 2 decimais com vÃ­rgula
    function maskPct(input){
      let v = input.value.replace(/[^\d,]/g,'');
      // permite sÃ³ uma vÃ­rgula
      let parts = v.split(',');
      if(parts.length > 2) v = parts[0]+','+parts.slice(1).join('');
      if(parts[1] && parts[1].length > 2) v = parts[0]+','+parts[1].substring(0,2);
      input.value = v;
    }

    // Aplica mÃ¡scaras nos campos corretos
    const moneyFields = ['valor','pmtDesejado','descPixBrl','descAvistaBrl','cashbackBrl'];
    const pctFields = ['descPix','descAvista','cashback','cdi','pctCdiBanco','ir'];

    moneyFields.forEach(id => {
      const node = el(id);
      if(node) node.addEventListener('input', ()=>{ maskMoney(node); calc(); });
    });
    pctFields.forEach(id => {
      const node = el(id);
      if(node) node.addEventListener('input', ()=>{ maskPct(node); calc(); });
    });

    const otherInputs = ['parcelas','fechamento','vencimento','nAuto'];
    otherInputs.forEach(i=>{ const node=el(i); if(node) node.addEventListener('input', calc); });

    // Toggle Desconto Ã  vista no cartÃ£o
    let descAvistaModo = 'pct';
    const swTrackAvista = el('swTrackDescAvista');
    const toggleDivAvista = el('toggleDescAvista');
    swTrackAvista.addEventListener('click', () => {
      descAvistaModo = descAvistaModo === 'pct' ? 'brl' : 'pct';
      const isBrl = descAvistaModo === 'brl';
      swTrackAvista.classList.toggle('on', isBrl);
      toggleDivAvista.classList.toggle('is-brl', isBrl);
      el('wrapDescAvistaPct').style.display = isBrl ? 'none' : 'flex';
      el('wrapDescAvistaBrl').style.display = isBrl ? 'flex' : 'none';
      el('pctDescAvista').style.display = isBrl ? 'block' : 'none';
      el('descAvista').value = '';
      el('descAvistaBrl').value = '';
      el('pctDescAvista').textContent = '';
      calc();
    });
    let descPixModo = 'pct'; // 'pct' ou 'brl'
    const swTrack = el('swTrackDescPix');
    const toggleDiv = el('toggleDescPix');
    swTrack.addEventListener('click', () => {
      descPixModo = descPixModo === 'pct' ? 'brl' : 'pct';
      const isBrl = descPixModo === 'brl';
      swTrack.classList.toggle('on', isBrl);
      toggleDiv.classList.toggle('is-brl', isBrl);
      el('wrapDescPixPct').style.display = isBrl ? 'none' : 'flex';
      el('wrapDescPixBrl').style.display = isBrl ? 'flex' : 'none';
      el('pctDescPix').style.display = isBrl ? 'block' : 'none';
      el('descPix').value = '';
      el('descPixBrl').value = '';
      el('pctDescPix').textContent = '';
      calc();
    });
    function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }

    function proxData(dia){
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      const dHoje = now.getDate();
      const thisDay = Math.min(dia, daysInMonth(y,m));
      if(dHoje <= dia){ return new Date(y, m, thisDay); }
      const nextMonth = m+1;
      return new Date(y, nextMonth, Math.min(dia, daysInMonth(y,nextMonth)));
    }

    function diffDias(a,b){ // b - a
      const d1 = new Date(a.getFullYear(),a.getMonth(),a.getDate(),12);
      const d2 = new Date(b.getFullYear(),b.getMonth(),b.getDate(),12);
      const ms = d2 - d1; // 12h para evitar DST
      return Math.max(0, Math.round(ms/86400000));
    }

    function pmt(rate, nper, pv, fv=0, type=0){
      if(nper<=0) return NaN;
      if(rate === 0) return -(pv+fv)/nper;
      const r1 = Math.pow(1+rate, nper);
      return -(rate*(pv*r1 + fv)) / ((1+rate*type)*(r1-1));
    }
    function nperSolve(rate, pmtVal, pv, fv=0, type=0){
      if(!isFinite(rate) || rate<0 || !isFinite(pmtVal) || pmtVal===0) return NaN;
      if(pv<=0) return NaN;
      const typeAdj = (1+rate*type);
      const f = (n)=> pv + pmtVal*typeAdj*(1 - Math.pow(1+rate, -n))/rate + fv*Math.pow(1+rate, -n);
      let lo=1, hi=600; while(f(hi)>0 && hi<2000) hi*=2;
      for(let i=0;i<100;i++){
        const mid = (lo+hi)/2; const val = f(mid);
        if(Math.abs(val) < 1e-8) return mid;
        if(val>0) lo=mid; else hi=mid;
      }
      return Math.ceil((lo+hi)/2);
    }

    function calc(){
      const valor = safeNum(el('valor').value);

      // Desconto PIX: modo % ou R$
      let descPix = 0;
      if(descPixModo === 'pct'){
        descPix = safeNum(el('descPix').value)/100;
      } else {
        const descPixValor = safeNum(el('descPixBrl').value);
        descPix = (valor > 0 && descPixValor > 0) ? descPixValor / valor : 0;
        el('pctDescPix').textContent = (valor > 0 && descPixValor > 0) ? 'â‰ˆ ' + (descPix*100).toFixed(2).replace('.',',') + '%' : '';
      }
      // Desconto Ã  vista no cartÃ£o: modo % ou R$
      let descAvista = 0;
      if(descAvistaModo === 'pct'){
        descAvista = safeNum(el('descAvista').value)/100;
      } else {
        const descAvistaValor = safeNum(el('descAvistaBrl').value);
        descAvista = (valor > 0 && descAvistaValor > 0) ? descAvistaValor / valor : 0;
        el('pctDescAvista').textContent = (valor > 0 && descAvistaValor > 0) ? 'â‰ˆ ' + (descAvista*100).toFixed(2).replace('.',',') + '%' : '';
      }
      // Cashback: modo % ou R$
      let cashback = 0;
      if(cashbackModo === 'pct'){
        cashback = safeNum(el('cashback').value)/100;
      } else {
        const cashbackValor = safeNum(el('cashbackBrl').value);
        cashback = (valor > 0 && cashbackValor > 0) ? cashbackValor / valor : 0;
        el('pctCashback').textContent = (valor > 0 && cashbackValor > 0) ? 'â‰ˆ ' + (cashback*100).toFixed(2).replace('.',',') + '%' : '';
      }
      const nParcelas = Math.max(1, Math.floor(safeNum(el('parcelas').value))||0);
      const diaFech = Math.min(31, Math.max(1, Math.floor(safeNum(el('fechamento').value)||20)));
      const diaVenc = Math.min(31, Math.max(1, Math.floor(safeNum(el('vencimento').value)||27)));

      // ParÃ¢metros anuais
      const cdiAnnual = safeNum(el('cdi').value)/100; // ao ano
      const pctCdiBanco = safeNum(el('pctCdiBanco').value)/100; // 100% etc
      const ir = safeNum(el('ir').value)/100;
      const cdiConservador = 0.001; // 0,10% a.a.

      // Taxas equivalentes
      const effAnnual = Math.max(0, (cdiAnnual - cdiConservador) * pctCdiBanco * (1 - ir));
      const taxaMensal = Math.pow(1 + effAnnual, 1/12) - 1;
      const taxaDiaria = Math.pow(1 + taxaMensal, 1/30) - 1;

      const hoje = new Date();
      const fecha = proxData(diaFech);
      const vence = proxData(diaVenc);
      const diasAtePagar = diffDias(hoje, vence);

      // PIX (imediato)
      const pixReal = valor * (1 - descPix);

      // CartÃ£o Ã  vista (traz a PV e aplica cashback/descAvista)
      const avistaPV = valor * (1 - descAvista) * (1 - cashback) / Math.pow(1+taxaDiaria, diasAtePagar);

      // CartÃ£o parcelado: PV das parcelas menos PV do cashback na fatura
      const parcela = valor / nParcelas;
      let pvParcelas = 0;
      for(let k=0;k<nParcelas;k++){
        const dias = diasAtePagar + 30*k;
        pvParcelas += parcela / Math.pow(1+taxaDiaria, dias);
      }
      const pvCashback = (cashback>0)? (valor * cashback) / Math.pow(1+taxaDiaria, diasAtePagar) : 0;
      let parceladoPV = pvParcelas - pvCashback;

      // ForÃ§a igualdade numÃ©rica quando Ã© 1 parcela e sem desc. Ã  vista
      if(nParcelas===1 && descAvista===0){ parceladoPV = avistaPV; }

      // DecisÃ£o
      const melhorVal = Math.min(pixReal, avistaPV, parceladoPV);
      const melhor = (melhorVal===pixReal)? 'PAGUE NO PIX' : (melhorVal===avistaPV? 'CARTÃƒO Ã€ VISTA' : 'PARCELADO');

      // Descontos necessÃ¡rios (equivalentes aos seus E5/E6)
      const descNecPix = valor>0? 1 - (Math.min(avistaPV, parceladoPV) / valor) : NaN;
      const descNecAvista = valor>0? 1 - (Math.min(pixReal, parceladoPV) / valor) : NaN;

      // Autoâ€‘financiamento
      const nAuto = Math.max(0, Math.floor(safeNum(el('nAuto').value)||0));
      const custoRef = melhorVal; // usa o menor custo como PV
      const pmtMes = (nAuto>0 && custoRef>0)? pmt(taxaMensal, nAuto, -custoRef) : NaN;
      // Valor mÃ¡ximo por mÃªs â†’ encontra nper e recalcula parcela exata
      const pmtDesejado = safeNum(el('pmtDesejado').value);
      const nperCalc = (pmtDesejado>0 && custoRef>0)? Math.ceil( nperSolve(taxaMensal, -pmtDesejado, custoRef) ) : NaN;
      // Parcela exata para o nperCalc encontrado (â‰¤ pmtDesejado)
      const pmtExato = (isFinite(nperCalc) && nperCalc>1 && custoRef>0)? pmt(taxaMensal, nperCalc, -custoRef) : NaN;

      // Render
      el('hoje').textContent = hoje.toLocaleDateString('pt-BR');
      el('fecha').textContent = fecha.toLocaleDateString('pt-BR');
      el('vence').textContent = vence.toLocaleDateString('pt-BR');
      el('diasAte').textContent = diasAtePagar + ' d';
      el('taxaMensal').textContent = fmtPct(taxaMensal);
      el('taxaDiaria').textContent = fmtPct(taxaDiaria);

      el('pixReal').textContent = fmtBRL(pixReal);
      el('avistaReal').textContent = fmtBRL(avistaPV);
      el('parceladoReal').textContent = (nParcelas > 1) ? fmtBRL(parceladoPV) : 'â€”';

      el('melhor').textContent = melhor;
      el('descNecPix').textContent = isFinite(descNecPix)? ((descNecPix<0? '-':'') + (100*Math.abs(descNecPix)).toFixed(2).replace('.',',') + '%') : 'â€”';
      el('descNecAvista').textContent = isFinite(descNecAvista)? ((descNecAvista<0? '-':'') + (100*Math.abs(descNecAvista)).toFixed(2).replace('.',',') + '%') : 'â€”';

      const pmtTotalVal = (isFinite(pmtMes) && nAuto > 1) ? pmtMes * nAuto : NaN;
      const pmtTaxaVal = (isFinite(pmtTotalVal) && melhorVal > 0) ? (pmtTotalVal / melhorVal - 1) : NaN;

      el('pmtAuto').textContent = (isFinite(pmtMes) && nAuto > 1) ? fmtBRL(pmtMes) : 'â€”';
      el('pmtTotal').textContent = isFinite(pmtTotalVal) ? fmtBRL(pmtTotalVal) : 'â€”';
      el('pmtTaxa').textContent = isFinite(pmtTaxaVal) ? ((pmtTaxaVal * 100).toFixed(2).replace('.', ',') + '%') : 'â€”';
      el('nperAuto').textContent = (isFinite(nperCalc) && nperCalc>1)? nperCalc+' meses' : 'â€”';
      el('nperParcela').textContent = (isFinite(pmtExato) && nperCalc>1)? fmtBRL(pmtExato) : 'â€”';

      const nperTotalVal = (isFinite(pmtExato) && nperCalc > 1) ? pmtExato * nperCalc : NaN;
      const nperTaxaVal = (isFinite(nperTotalVal) && melhorVal > 0) ? (nperTotalVal / melhorVal - 1) : NaN;
      el('nperTotal').textContent = isFinite(nperTotalVal) ? fmtBRL(nperTotalVal) : 'â€”';
      el('nperTaxa').textContent = isFinite(nperTaxaVal) ? ((nperTaxaVal * 100).toFixed(2).replace('.', ',') + '%') : 'â€”';
    }

    // Toggle Cashback do cartÃ£o
    let cashbackModo = 'pct';
    el('swTrackCashback').addEventListener('click', () => {
      cashbackModo = cashbackModo === 'pct' ? 'brl' : 'pct';
      const isBrl = cashbackModo === 'brl';
      el('swTrackCashback').classList.toggle('on', isBrl);
      el('toggleCashback').classList.toggle('is-brl', isBrl);
      el('wrapCashbackPct').style.display = isBrl ? 'none' : 'flex';
      el('wrapCashbackBrl').style.display = isBrl ? 'flex' : 'none';
      el('pctCashback').style.display = isBrl ? 'block' : 'none';
      el('cashback').value = isBrl ? '' : '1,65';
      el('cashbackBrl').value = '';
      el('pctCashback').textContent = '';
      calc();
    });

    // Toggle modo Auto-Financiamento: nÂº parcelas / valor mÃ¡ximo
    let autoFinModo = 'nper'; // 'nper' ou 'valor'
    el('swModoAuto').addEventListener('click', () => {
      autoFinModo = autoFinModo === 'nper' ? 'valor' : 'nper';
      const isValor = autoFinModo === 'valor';
      el('swModoAuto').classList.toggle('on', isValor);
      el('lblModoNper').style.color = isValor ? 'var(--text3)' : 'var(--acc)';
      el('lblModoValor').style.color = isValor ? 'var(--acc)' : 'var(--text3)';
      el('modoNper').style.display = isValor ? 'none' : '';
      el('modoValor').style.display = isValor ? '' : 'none';
      calc();
    });

    // Recolher/expandir Auto-Financiamento (padrÃ£o: recolhido)
    let autoFinAberto = false;
    el('toggleAutoFin').addEventListener('click', () => {
      autoFinAberto = !autoFinAberto;
      el('bodyAutoFin').style.display = autoFinAberto ? '' : 'none';
      el('iconAutoFin').textContent = autoFinAberto ? 'âˆ’' : '+';
    });

    // Recolher/expandir ParÃ¢metros financeiros (padrÃ£o: recolhido)
    let paramsAberto = false;
    el('toggleParams').addEventListener('click', () => {
      paramsAberto = !paramsAberto;
      el('bodyParams').style.display = paramsAberto ? '' : 'none';
      el('iconParams').textContent = paramsAberto ? 'âˆ’' : '+';
    });

    // PersistÃªncia: carrega fechamento, vencimento e parÃ¢metros financeiros salvos
    const savedFech = localStorage.getItem('ec_fechamento');
    const savedVenc = localStorage.getItem('ec_vencimento');
    if(savedFech) el('fechamento').value = savedFech;
    if(savedVenc) el('vencimento').value = savedVenc;

    const savedCdi = localStorage.getItem('ec_cdi');
    const savedPctCdi = localStorage.getItem('ec_pctCdiBanco');
    const savedIr = localStorage.getItem('ec_ir');
    if(savedCdi) el('cdi').value = savedCdi;
    if(savedPctCdi) el('pctCdiBanco').value = savedPctCdi;
    if(savedIr) el('ir').value = savedIr;

    // Salva automaticamente ao alterar
    el('fechamento').addEventListener('change', () => localStorage.setItem('ec_fechamento', el('fechamento').value));
    el('vencimento').addEventListener('change', () => localStorage.setItem('ec_vencimento', el('vencimento').value));
    const savedCashback = localStorage.getItem('ec_cashback');
    if(savedCashback) el('cashback').value = savedCashback;

    el('cashback').addEventListener('change', () => localStorage.setItem('ec_cashback', el('cashback').value));
    el('pctCdiBanco').addEventListener('change', () => localStorage.setItem('ec_pctCdiBanco', el('pctCdiBanco').value));
    el('ir').addEventListener('change', () => localStorage.setItem('ec_ir', el('ir').value));

    // Inicializa
    calc();

    // â”€â”€ Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('[SW] registrado'))
        .catch(err => console.warn('[SW] erro:', err));
    }

    // â”€â”€ Banner "Adicionar Ã  tela inicial" (Android Chrome) â”€â”€â”€â”€â”€â”€
    let deferredPrompt = null;
    const banner = document.getElementById('install-banner');
    const btnInstall = document.getElementById('btn-install');
    const btnDismiss = document.getElementById('btn-dismiss');

    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      banner.style.display = 'flex';
    });

    btnInstall && btnInstall.addEventListener('click', () => {
      banner.style.display = 'none';
      if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; }
    });

    btnDismiss && btnDismiss.addEventListener('click', () => {
      banner.style.display = 'none';
    });

    window.addEventListener('appinstalled', () => {
      banner.style.display = 'none';
    });
  </script>
</body>
</html>
